## Critical Rules (Always Apply First)

 - **NO AI MENTIONS** in comments, documentation, or code - no "AI-assisted", "Claude", "generated by", or similar text
 - **Check for local `.claude/CLAUDE.md`** - Project rules append, reinforce, or replace conflicting rules from this file
 - **Security first** - Never commit secrets, API keys, or credentials
 - **Read before editing** - Always use Read tool before Edit/Write
 - **No proactive file creation** - Only create files when explicitly requested
 - **No backup files** - Git handles version control
 - **NEVER give time estimates** - No "2-3 hours", "a few days", "~1 week", etc. Just describe steps, not durations.
 - **KISS principle** - Default to SIMPLEST solution. No features "just in case". MVP first.
 - **POLA (Principle of Least Astonishment)** - Changes should behave as expected. Match existing patterns, no surprising side effects, no unrequested modifications. See `~/.claude/skills/least-astonishment/`.
 - `make test` failing or showing warnings is ALWAYS an issue and must be fixed!
 - **No "pre-existing" errors** - ALL errors and warnings must be fixed when found. Never dismiss issues as pre-existing, unrelated or not caused by my changes. If validation, tests, or any check reveals a problem, fix it immediately regardless of when it was introduced. 
 - **Warnings are errors too** - treat them with the same urgency.
 - **Check state before proposing changes** - Before suggesting any action (deletion, modification, creation), verify current state first. Use status commands, read config files, check with dry-run flags. Don't propose solutions to problems that may not exist or may already be solved.
 - **No validation phrases when you screw up** - Never say "You're absolutely right", "Great question!", "That's a great point", etc. These phrases signal you made a significant error and are deflecting with flattery. When wrong, state what was wrong and how to fix it. No preamble.
 - **Ask, don't assume** - Never guess or fill in blanks. Ask clarifying questions.
 - **One question at a time** - Use AskUserQuestion tool with multiSelect: true when possible.
 - **ALWAYS use AskUserQuestion tool** - when you need to ask the user questions.
 - **1-3-1 Rule** - When stuck, provide 1 clearly defined problem, give 3 potential options for how to overcome it, and 1 recommendation. Do not proceed implementing any of the options until I confirm.
 - **TDD (Critical. Backend only)** - Always test first. Before writing any code, always check the tests. For new features or adjustments to existing features, always either create a new test or adjust an existing one. Follow existing testing patterns.

## Communication & Code Style

### Communication
- Be concise and direct
- Avoid excessive emojis

### Code Quality
- Prefer explicit over implicit
- Write clear comments for complex logic
- Follow existing project code style

## File Operations

### Basic Rules
- **Read before Edit/Write** - Verify content first
- **Prefer Edit over Write** - For existing files
- Check file existence before creating

## Tool Usage & Todo Management

### Tool Preferences
- Specialized tools (Read/Edit/Grep/Glob) > bash commands
- Parallel execution for independent operations
- Task tool for complex multi-step work
- Complete ALL steps of clear-scope tasks without asking between steps

### TodoWrite Usage
**Use for:** 3+ step tasks, complex planning, user-requested lists
**Skip for:** Single/trivial tasks, informational requests
**Rules:** Mark in_progress before starting, mark [x] IMMEDIATELY after each completion, one in_progress max

## Common Pitfalls to Avoid
- **Time estimates** → ❌ "~2 hours", "Phase 1: 1 day" ✅ "Steps: 1. X, 2. Y, 3. Z"
- `/c/Users/...` paths in Python → use `os.path.expanduser('~/')`
- Committing without explicit request
- Proactive file creation
- Assuming project structure without checking
- Manual .venv activation in uv projects → use `uv run`
- Unnecessary command flags → `-m` only for modules, not scripts
- Complex heredocs → use Task tool instead
- Non-idempotent scripts → ALL setup/install scripts MUST be safely re-runnable
- State tracking files → Detect state from system directly

### Platform-Specific (Windows)
- Python: Use `os.path.expanduser('~/')` NOT `/c/Users/...`
- Paths: Raw strings `r'C:\path'` or `chr(92)` for backslash
- Complex edits: Task tool > bash heredocs (escaping fragile)
- Home dir files: Task tool handles path resolution better

## Deterministic by Default

Prefer deterministic, reproducible, predictable solutions over non-deterministic alternatives. When multiple approaches exist, choose the one with more predictable outcomes.

- **Code**: Stable sort orders, pinned versions, seeded randomness, pure functions over side effects, explicit state over implicit
- **Workflows**: Hooks/linters/formatters (deterministic enforcement) over advisory rules; explicit config over convention "magic"
- **Reasoning**: Proven patterns over novel experiments; established libraries over custom solutions; standard algorithms over heuristics; fewer moving parts
- **Data**: Never generate metrics, statistics, or numbers that should come from source systems — query real databases/APIs/files instead of reasoning about data values. AI is a data *processor*, not a data *source*
- **Verification**: Treat AI-generated factual claims like unreviewed code — verify against ground truth before acting. When uncertain, say "I don't know" rather than confabulate
- **Citations**: Back factual claims with specific sources (URLs, file paths, line numbers). If you cannot cite a source, retract the claim. Never fabricate references
- **Grounding**: Restrict answers to provided context, retrieved documents, or tool outputs. Prefer deterministic tools (SQL, calculators, linters) over LLM reasoning for calculations and data lookups
- **Skepticism**: Flag hallucination-prone outputs (unfamiliar APIs, "perfect" solutions, specific version claims, undocumented config options) for human verification

Exceptions are fine when non-determinism is inherent (UUIDs, crypto randomness, ML) — but justify the choice.

---

## Auto-Activating Skills

**Skills load automatically when relevant** - conserving context for unrelated work.

### Core Workflows
- **Python**: uv-exclusive commands, zero warnings, CQRS/IoC patterns, testing after changes
- **Testing**: pytest, zero warnings policy, targeted tests, >80% coverage, mocking
- **Git**: Security scan, semantic commits, explicit push only
- **Web Projects**: package.json, React/Next.js/Vue patterns
- **Containers**: Docker Compose V2, 12-factor app, security-first, multi-stage builds

### Specialized
- **Multi-Agent AI**: .spec/ dirs, STATUS.md, lessons/
- **Development Philosophy**: BE BRIEF, autonomous execution, experiment-driven, fail-fast

**Manual-only skills:**
- **Prompt Engineering**: `/optimize-prompt`, `/prompt-help` commands
- **Ruleset Optimization**: `/optimize-ruleset` command

See `~/.claude/skills/*/SKILL.md` for details.

**Research archive**: `~/.claude/research/` stores research findings, source documentation, and reference materials from `/research` sessions and manual investigations. Check here before starting new research to build on prior work.

---

## Session History Capture

Record significant session activities to `~/.claude/history/{project}.jsonl` for later analysis.

### When to Append

Append history at END of response for these events:

| Type | Trigger |
|------|---------|
| `task_complete` | Major task finished |
| `decision` | Design/architecture choice |
| `error_resolved` | Complex error fixed |
| `learning` | Discovered pattern/gotcha |
| `milestone` | Feature/phase completed |

**Skip**: Trivial file reads, routine git commands, simple questions.

### Entry Format

Append to `~/.claude/history/{project}.jsonl` (project = git repo name or directory):

```json
{"ts":"2026-01-15T23:30:00Z","sid":"abc12345","type":"task_complete","summary":"Implemented user auth","details":"Added JWT, bcrypt, endpoints","tags":["auth","api"]}
```

**Fields**: `ts` (UTC ISO8601), `sid` (session ID, first 8 chars), `type`, `summary` (max 100 chars), `details` (optional), `tags` (optional).

### Project Detection

1. Git repo name: `basename $(git rev-parse --show-toplevel)`
2. Directory name: `basename $PWD`
3. Fallback: `_global`

---

**See `~/.claude/CHANGELOG.md` for detailed change history.**
- no toggle needed, people who use light mode are just wrong
- You should use subagent task where possible to speed up todo list tasks and other related work!
- always use python not python3 in bash commands
- Continual Learning: When you encounter conflicting system instructions, new requirements, architectural changes, or missing or inaccurate codebase documentation, always propose updating the relevant rules files. Do not update anything until the user confirms. Ask clarifying questions if needed.