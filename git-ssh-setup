#!/usr/bin/env bash

# Configure git SSH keys based on what's available
# Writes to ~/.gitconfig-*-local files (gitignored, machine-specific)
# Priority for personal: id_ed25519-personal > id_ed25519
# Priority for work: id_ed25519-work > id_ed25519-eagletg

SSH_DIR="${HOME}/.ssh"

# Find the best available personal SSH key (returns portable path with ~)
find_personal_key() {
    for key in "id_ed25519-personal" "id_ed25519"; do
        if [[ -f "${SSH_DIR}/${key}" ]]; then
            echo "~/.ssh/${key}"
            return 0
        fi
    done
    return 1
}

# Find the best available work SSH key (returns portable path with ~)
find_work_key() {
    for key in "id_ed25519-work" "id_ed25519-eagletg"; do
        if [[ -f "${SSH_DIR}/${key}" ]]; then
            echo "~/.ssh/${key}"
            return 0
        fi
    done
    return 1
}

# Build sshCommand - only include -F if config exists
build_ssh_command() {
    local key="$1"
    if [[ -f "${SSH_DIR}/config" ]]; then
        echo "ssh -i $key -F ~/.ssh/config"
    else
        echo "ssh -i $key"
    fi
}

# Write local gitconfig with SSH command (creates or updates)
write_local_config() {
    local config_file="$1"
    local ssh_command="$2"
    local expected="[core]
	sshCommand = $ssh_command"

    # Check if file exists and has correct content (idempotency)
    if [[ -f "$config_file" ]]; then
        local current
        current=$(cat "$config_file")
        if [[ "$current" == "$expected" ]]; then
            return 0  # Already correct
        fi
    fi

    # Write the config
    echo "$expected" > "$config_file"
}

echo "Configuring Git SSH keys..."

# Configure personal key
personal_key=$(find_personal_key)
if [[ -n "$personal_key" ]]; then
    ssh_cmd=$(build_ssh_command "$personal_key")
    write_local_config "${HOME}/.gitconfig-personal-local" "$ssh_cmd"
    echo "  Personal: $personal_key"
else
    echo "  Personal: No key found (checked id_ed25519-personal, id_ed25519)"
fi

# Configure work key
work_key=$(find_work_key)
if [[ -n "$work_key" ]]; then
    ssh_cmd=$(build_ssh_command "$work_key")
    write_local_config "${HOME}/.gitconfig-professional-local" "$ssh_cmd"
    echo "  Work: $work_key"
else
    echo "  Work: No key found (checked id_ed25519-work, id_ed25519-eagletg)"
fi

echo "  Done"
