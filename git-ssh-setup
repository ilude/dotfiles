#!/usr/bin/env bash

# Configure git SSH keys based on what's available
# Priority for personal: id_ed25519-personal > id_ed25519
# Priority for work: id_ed25519-work > id_ed25519-eagletg

DOTFILES_DIR="${HOME}/.dotfiles"
SSH_DIR="${HOME}/.ssh"

# Cross-platform sed -i (macOS requires '' argument)
sed_inplace() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

# Find the best available personal SSH key (returns portable path with ~)
find_personal_key() {
    for key in "id_ed25519-personal" "id_ed25519"; do
        if [[ -f "${SSH_DIR}/${key}" ]]; then
            echo "~/.ssh/${key}"
            return 0
        fi
    done
    return 1
}

# Find the best available work SSH key (returns portable path with ~)
find_work_key() {
    for key in "id_ed25519-work" "id_ed25519-eagletg"; do
        if [[ -f "${SSH_DIR}/${key}" ]]; then
            echo "~/.ssh/${key}"
            return 0
        fi
    done
    return 1
}

# Build sshCommand - only include -F if config exists
build_ssh_command() {
    local key="$1"
    if [[ -f "${SSH_DIR}/config" ]]; then
        echo "ssh -i $key -F ~/.ssh/config"
    else
        echo "ssh -i $key"
    fi
}

# Update gitconfig file with the correct SSH command
update_gitconfig() {
    local config_file="$1"
    local ssh_command="$2"

    if [[ ! -f "$config_file" ]]; then
        echo "  Warning: $config_file not found, skipping"
        return 1
    fi

    # Check current value to avoid unnecessary writes (idempotency)
    local current
    current=$(grep "sshCommand = " "$config_file" 2>/dev/null | sed 's/.*sshCommand = //')
    if [[ "$current" == "$ssh_command" ]]; then
        return 0  # Already correct, no change needed
    fi

    # Update or add sshCommand
    if grep -q "sshCommand" "$config_file"; then
        sed_inplace "s|sshCommand = .*|sshCommand = $ssh_command|" "$config_file"
    else
        # Add sshCommand under [core] section
        sed_inplace '/^\[core\]/a\
	sshCommand = '"$ssh_command" "$config_file"
    fi
}

echo "Configuring Git SSH keys..."

# Configure personal key
personal_key=$(find_personal_key)
if [[ -n "$personal_key" ]]; then
    ssh_cmd=$(build_ssh_command "$personal_key")
    update_gitconfig "${DOTFILES_DIR}/.gitconfig-personal" "$ssh_cmd"
    echo "  Personal: $personal_key"
else
    echo "  Personal: No key found (checked id_ed25519-personal, id_ed25519)"
fi

# Configure work key
work_key=$(find_work_key)
if [[ -n "$work_key" ]]; then
    ssh_cmd=$(build_ssh_command "$work_key")
    update_gitconfig "${DOTFILES_DIR}/.gitconfig-professional" "$ssh_cmd"
    echo "  Work: $work_key"
else
    echo "  Work: No key found (checked id_ed25519-work, id_ed25519-eagletg)"
fi

echo "  Done"
