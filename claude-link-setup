#!/usr/bin/env bash

# Create ~/.claude link to dotfiles
# Windows: uses junction (no admin required)
# Linux: uses symlink

DOTFILES_DIR="${HOME}/.dotfiles"
CLAUDE_SOURCE="${DOTFILES_DIR}/.claude"
CLAUDE_TARGET="${HOME}/.claude"

# Detect Windows
is_windows() {
    [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

echo "Setting up Claude Code directory link..."

# Check if source exists
if [[ ! -d "$CLAUDE_SOURCE" ]]; then
    echo "  Error: Source directory not found: $CLAUDE_SOURCE"
    exit 1
fi

# Check if target already correct
if [[ -L "$CLAUDE_TARGET" ]]; then
    current_target=$(readlink -f "$CLAUDE_TARGET" 2>/dev/null || readlink "$CLAUDE_TARGET")
    expected_target=$(readlink -f "$CLAUDE_SOURCE" 2>/dev/null || echo "$CLAUDE_SOURCE")
    if [[ "$current_target" == "$expected_target" ]] || [[ "$current_target" == "$CLAUDE_SOURCE" ]]; then
        echo "  ~/.claude: Already linked correctly"
        exit 0
    fi
fi

# Remove existing target if it exists
if [[ -e "$CLAUDE_TARGET" ]] || [[ -L "$CLAUDE_TARGET" ]]; then
    echo "  Removing existing ~/.claude..."
    rm -rf "$CLAUDE_TARGET"
fi

# Create link
if is_windows; then
    # Windows: use junction (doesn't require admin)
    win_target=$(cygpath -w "$CLAUDE_TARGET")
    win_source=$(cygpath -w "$CLAUDE_SOURCE")
    if cmd //c "mklink /J $win_target $win_source" > /dev/null 2>&1; then
        echo "  ~/.claude: Junction created"
    else
        echo "  Error: Failed to create junction"
        exit 1
    fi
else
    # Linux/macOS: use symlink
    ln -s "$CLAUDE_SOURCE" "$CLAUDE_TARGET"
    echo "  ~/.claude: Symlink created"
fi
