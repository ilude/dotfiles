#!/usr/bin/env bash

set -e

completed_steps=()
current_step=""
install_failed=0
trap 'install_failed=$?' ERR
# shellcheck disable=SC2154
trap 'echo ""; echo "=== Install Summary ==="; for s in "${completed_steps[@]}"; do echo "  [done] $s"; done; if [[ $install_failed -ne 0 ]]; then echo "  [FAIL] $current_step"; fi' EXIT

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Self-contained platform detection (intentionally not sourcing rc.d/00-helpers.zsh)
is_windows() {
  [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

# Windows notice
if is_windows; then
    echo "=== Dotfiles Installer (Git Bash) ==="
    echo ""
    echo "For full package installation, run in PowerShell:"
    echo "  ~/.dotfiles/install.ps1"
    echo ""
    echo "Proceeding with dotbot + zsh setup..."
    echo ""
fi

current_step="XDG migration"
# Migrate from ~/.gitconfig to XDG path (~/.config/git/config)
# Remove old symlink/file so git uses the XDG location instead
if [[ -e "$HOME/.gitconfig" || -L "$HOME/.gitconfig" ]]; then
    echo "Migrating ~/.gitconfig -> ~/.config/git/config (XDG)"
    rm -f "$HOME/.gitconfig"
fi
if [[ -e "$HOME/.gitignore_global" || -L "$HOME/.gitignore_global" ]]; then
    echo "Migrating ~/.gitignore_global -> ~/.config/git/ignore (XDG)"
    rm -f "$HOME/.gitignore_global"
fi
completed_steps+=("XDG migration")

current_step=".env migration"
if [[ -f "$BASEDIR/.secrets" && ! -f "$BASEDIR/.env" ]]; then
    echo "Migrating .secrets -> .env"
    mv "$BASEDIR/.secrets" "$BASEDIR/.env"
elif [[ -f "$BASEDIR/.secrets" && -f "$BASEDIR/.env" ]]; then
    echo "Warning: both .secrets and .env exist - using .env (remove .secrets manually)"
fi
completed_steps+=(".env migration")

current_step="Dotbot symlinks"
cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"
"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"
completed_steps+=("Dotbot symlinks")

current_step="MSYS2 zsh bootstrap"
# MSYS2 zsh bootstrap: create redirect from /home/$USER to Windows home
# This fixes the HOME mismatch between Git Bash and MSYS2's zsh
if is_windows && [[ -d "/home/$USER" ]]; then
    target="/home/$USER/.zshrc"
    source="${BASEDIR}/zsh/zshrc-msys2-bootstrap"
    if [[ -f "$target" ]] && cmp -s "$source" "$target"; then
        echo "MSYS2 bootstrap: already correct"
    else
        echo "Creating MSYS2 zsh bootstrap..."
        cp "$source" "$target"
        echo "  Created $target"
    fi
fi
completed_steps+=("MSYS2 zsh bootstrap")

# Skip GUI tools on headless Linux servers
if [[ -z "$DISPLAY" ]] && [[ -z "$WAYLAND_DISPLAY" ]] && [[ -z "$WSL_DISTRO_NAME" ]] && ! is_windows; then
    echo "Headless server detected - skipping GUI tool setup"
    HEADLESS=1
fi

current_step="Git SSH setup"
"${BASEDIR}/scripts/git-ssh-setup"
completed_steps+=("Git SSH setup")

current_step="Zsh setup"
"${BASEDIR}/scripts/zsh-setup"
completed_steps+=("Zsh setup")

current_step="uv install"
# Install uv (Python package manager) - required for Claude Code hooks
if command -v uv &>/dev/null; then
    echo "uv: already installed"
else
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/0.6.6/install.sh | sh
fi
completed_steps+=("uv install")

current_step="Python dev tools"
if command -v uv &>/dev/null; then
    # Install ruff globally via uv tool (required for Claude Code quality hooks)
    if command -v ruff &>/dev/null; then
        echo "ruff: already installed"
    else
        echo "Installing ruff..."
        uv tool install ruff
    fi
fi
completed_steps+=("Python dev tools")

current_step="GUI tool setup"
if [[ -z "$HEADLESS" ]]; then
    "${BASEDIR}/scripts/claude-link-setup"
    "${BASEDIR}/scripts/opencode-link-setup"
    "${BASEDIR}/scripts/claude-mcp-setup"
    "${BASEDIR}/scripts/claude-plugins-setup"
    "${BASEDIR}/scripts/copilot-link-setup"
fi
completed_steps+=("GUI tool setup")

current_step="Credential lockdown"
# Lock down sensitive credential files
[[ -f "$HOME/.claude/.credentials.json" ]] && chmod 600 "$HOME/.claude/.credentials.json"
completed_steps+=("Credential lockdown")
