#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect Windows
is_windows() {
  [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

# Windows notice
if is_windows; then
    echo "=== Dotfiles Installer (Git Bash) ==="
    echo ""
    echo "For full package installation, run in PowerShell:"
    echo "  ~/.dotfiles/install.ps1"
    echo ""
    echo "Proceeding with dotbot + zsh setup..."
    echo ""
fi

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

# MSYS2 zsh bootstrap: create redirect from /home/$USER to Windows home
# This fixes the HOME mismatch between Git Bash and MSYS2's zsh
if is_windows && [[ -d "/home/$USER" ]]; then
    target="/home/$USER/.zshrc"
    source="${BASEDIR}/.zshrc-msys2-bootstrap"
    if [[ -f "$target" ]] && cmp -s "$source" "$target"; then
        echo "MSYS2 bootstrap: already correct"
    else
        echo "Creating MSYS2 zsh bootstrap..."
        cp "$source" "$target"
        echo "  Created $target"
    fi
fi

# Skip GUI tools on headless Linux servers
if [[ -z "$DISPLAY" ]] && [[ -z "$WAYLAND_DISPLAY" ]] && [[ -z "$WSL_DISTRO_NAME" ]] && ! is_windows; then
    echo "Headless server detected - skipping GUI tool setup"
    HEADLESS=1
fi

"${BASEDIR}/git-ssh-setup"
"${BASEDIR}/zsh-setup"
if [[ -z "$HEADLESS" ]]; then
    "${BASEDIR}/claude-link-setup"
    "${BASEDIR}/claude-mcp-setup"
    "${BASEDIR}/claude-plugins-setup"
    "${BASEDIR}/copilot-link-setup"
fi
