#!/bin/bash
# shellcheck disable=SC1090

# Use ZDOTDIR for dotfiles path (MSYS2's zsh has different HOME than Git Bash)
DOTFILES_HOME="${ZDOTDIR:-$HOME}"

# Function to download plugins from GitHub
function plugin() {
  local repo=$1
  local plugin_dir="${DOTFILES_HOME}/.dotfiles/plugins/${repo##*/}"

  if [ ! -d "$plugin_dir" ]; then
    echo "Installing plugin: $repo"
    git clone --depth 1 "https://github.com/$repo.git" "$plugin_dir" 2>/dev/null
    # chmod only on fresh clone, not every startup (slow on Windows)
    chmod g-w "$plugin_dir" 2>/dev/null
  fi

  # only run if we are being sourced from zsh
  if [ -n "$ZSH_VERSION" ]; then
    source "$plugin_dir/${repo##*/}.plugin.zsh"
  fi
}

# Create the plugins directory if it doesn't exist
mkdir -p "${DOTFILES_HOME}/.dotfiles/plugins"

plugin "zsh-users/zsh-autosuggestions"
plugin "zsh-users/zsh-completions"
# Syntax highlighting causes cursor flickering on Windows (ConPTY bug)
# Set ZSH_DISABLE_SYNTAX_HIGHLIGHTING=1 in rc.d/02-plugins.zsh to skip
[[ -z "$ZSH_DISABLE_SYNTAX_HIGHLIGHTING" ]] && plugin "zsh-users/zsh-syntax-highlighting"
plugin "joshskidmore/zsh-fzf-history-search"
# alias-tips disabled - requires python3, causes issues on Windows
# plugin "djui/alias-tips"