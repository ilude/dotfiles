#!/usr/bin/env bash

# Link OpenCode global commands to dotfiles Claude commands
# Windows: uses junction (no admin required)
# Linux/macOS: uses symlink

DOTFILES_DIR="${HOME}/.dotfiles"
COMMANDS_SOURCE="${DOTFILES_DIR}/claude/commands"
OPENCODE_CONFIG_DIR="${HOME}/.config/opencode"
COMMANDS_TARGET="${OPENCODE_CONFIG_DIR}/commands"

# Self-contained platform detection (intentionally not sourcing rc.d helpers)
is_windows() {
    [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

# Check if path is a junction (Windows) or symlink
is_link() {
    local path="$1"
    if is_windows; then
        if [[ -L "$path" ]]; then
            return 0
        fi
        local win_path
        win_path=$(cygpath -w "$path" 2>/dev/null)
        if [[ -n "$win_path" ]] && cmd //c "dir /AL \"$(dirname "$win_path")\"" 2>/dev/null | grep -q "$(basename "$path")"; then
            return 0
        fi
        return 1
    else
        [[ -L "$path" ]]
    fi
}

echo "Setting up OpenCode shared commands..."

if [[ ! -d "$COMMANDS_SOURCE" ]]; then
    echo "  Error: Source directory not found: $COMMANDS_SOURCE"
    exit 1
fi

mkdir -p "$OPENCODE_CONFIG_DIR"

if is_link "$COMMANDS_TARGET"; then
    current_target=$(readlink -f "$COMMANDS_TARGET" 2>/dev/null || readlink "$COMMANDS_TARGET")
    expected_target=$(readlink -f "$COMMANDS_SOURCE" 2>/dev/null || echo "$COMMANDS_SOURCE")
    if [[ "$current_target" == "$expected_target" ]] || [[ "$current_target" == "$COMMANDS_SOURCE" ]]; then
        echo "  ~/.config/opencode/commands: Already linked correctly"
        exit 0
    fi
    echo "  Removing incorrect link..."
    rm -f "$COMMANDS_TARGET"
fi

# If commands dir already exists, merge unique files into source, then replace with link.
if [[ -d "$COMMANDS_TARGET" ]] && ! is_link "$COMMANDS_TARGET"; then
    echo "  Found existing OpenCode commands directory"
    echo "  Merging unique files into ~/.dotfiles/claude/commands..."
    cp -rn "$COMMANDS_TARGET/." "$COMMANDS_SOURCE/" 2>/dev/null || true
    rm -rf "$COMMANDS_TARGET"
fi

if [[ -e "$COMMANDS_TARGET" ]] || [[ -L "$COMMANDS_TARGET" ]]; then
    rm -rf "$COMMANDS_TARGET"
fi

if is_windows; then
    win_target=$(cygpath -w "$COMMANDS_TARGET")
    win_source=$(cygpath -w "$COMMANDS_SOURCE")
    if cmd //c "mklink /J $win_target $win_source" > /dev/null 2>&1; then
        echo "  ~/.config/opencode/commands: Junction created -> ~/.dotfiles/claude/commands"
    else
        echo "  Error: Failed to create junction"
        exit 1
    fi
else
    ln -s "$COMMANDS_SOURCE" "$COMMANDS_TARGET"
    echo "  ~/.config/opencode/commands: Symlink created -> ~/.dotfiles/claude/commands"
fi

echo "  Done"
