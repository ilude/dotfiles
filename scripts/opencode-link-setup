#!/usr/bin/env bash

# Set up OpenCode commands directory with overlay pattern:
# Since ~/.config/opencode -> ~/.dotfiles/opencode (via dotbot), the commands
# directory is ~/.dotfiles/opencode/commands/. This script populates it with:
# 1. Real files: OpenCode-specific overrides (e.g., commit.md with different model)
# 2. Symlinks: shared commands from claude/commands/ (for everything else)
# A .gitignore in that directory keeps the symlinks out of version control.

DOTFILES_DIR="${HOME}/.dotfiles"
CLAUDE_COMMANDS="${DOTFILES_DIR}/claude/commands"
OPENCODE_COMMANDS="${DOTFILES_DIR}/opencode/commands"

# Self-contained platform detection (intentionally not sourcing rc.d helpers)
is_windows() {
    [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

echo "Setting up OpenCode shared commands..."

if [[ ! -d "$CLAUDE_COMMANDS" ]]; then
    echo "  Error: Source directory not found: $CLAUDE_COMMANDS"
    exit 1
fi

mkdir -p "$OPENCODE_COMMANDS"

linked=0
skipped=0

for file in "$CLAUDE_COMMANDS"/*.md; do
    [[ -f "$file" ]] || continue
    filename=$(basename "$file")
    target="${OPENCODE_COMMANDS}/${filename}"

    # Skip if a real (non-symlink) override file exists
    if [[ -f "$target" ]] && [[ ! -L "$target" ]]; then
        ((skipped++))
        continue
    fi

    # Create or refresh symlink
    rm -f "$target"
    if is_windows; then
        MSYS=winsymlinks:nativestrict ln -sf "$file" "$target" 2>/dev/null
    else
        ln -sf "$file" "$target"
    fi
    ((linked++))
done

# Symlink subdirectories (e.g., yt/) unless a real override directory exists
for dir in "$CLAUDE_COMMANDS"/*/; do
    [[ -d "$dir" ]] || continue
    dirname=$(basename "$dir")
    target="${OPENCODE_COMMANDS}/${dirname}"

    # Skip if a real (non-symlink) override directory exists
    if [[ -d "$target" ]] && [[ ! -L "$target" ]]; then
        ((skipped++))
        continue
    fi

    rm -f "$target"
    if is_windows; then
        MSYS=winsymlinks:nativestrict ln -sf "$dir" "$target" 2>/dev/null
    else
        ln -sf "$dir" "$target"
    fi
    ((linked++))
done

# Clean up stale symlinks (commands removed from claude/commands)
for file in "$OPENCODE_COMMANDS"/*.md; do
    [[ -L "$file" ]] || continue
    if [[ ! -e "$file" ]]; then
        rm -f "$file"
    fi
done

echo "  ~/.config/opencode/commands: ${linked} shared, ${skipped} overridden"
echo "  Done"
