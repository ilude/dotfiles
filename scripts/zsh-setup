#!/usr/bin/env bash
# shellcheck disable=SC1090,SC1091

# Self-contained platform detection (intentionally not sourcing rc.d/00-helpers.zsh)
is_windows() {
  [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]]
}

# Detect macOS
is_macos() {
  [[ "$(uname -s)" == "Darwin" ]]
}

# Windows-specific setup
setup_windows() {
  echo "Windows detected (Git Bash/MSYS2)"
  echo ""

  # Check zsh is available
  if ! command -v zsh >/dev/null 2>&1; then
    echo "zsh not found. Install via:"
    echo "  pacman -S zsh   # Git Bash / MSYS2"
    echo ""
  else
    echo "zsh: $(which zsh)"
  fi

  # Check for fzf (required for zsh-fzf-history-search)
  if ! command -v fzf >/dev/null 2>&1; then
    echo "fzf not found. Install via:"
    echo "  winget install junegunn.fzf"
    echo ""
  else
    echo "fzf: $(which fzf)"
  fi

  # Check for eza (optional, for better ls)
  if ! command -v eza >/dev/null 2>&1; then
    echo "eza not found (optional). Install via:"
    echo "  winget install eza-community.eza"
    echo ""
  else
    echo "eza: $(which eza)"
  fi

  # Install zsh plugins (same as Linux)
  source ~/.dotfiles/scripts/zsh-plugins

  echo ""
  echo "Windows setup complete!"
  echo "Restart your terminal or run: source ~/.zshrc"
}

# Function to install necessary packages based on OS type
install_packages() {
  # Define package groups
  BASE_PACKAGES=(coreutils make ssh-import-id zsh zsh-autosuggestions zsh-syntax-highlighting)
  # Modern CLI tools (Ubuntu 24.04+ has these in apt)
  CLI_PACKAGES=(fzf ripgrep fd-find bat jq curl wget unzip)
  PYTHON_PACKAGES=(python3-dev python3-pip python3-setuptools)
  HEADER_PACKAGES=(linux-headers-generic)

  # Combine all package lists
  PACKAGES=("${BASE_PACKAGES[@]}" "${CLI_PACKAGES[@]}" "${HEADER_PACKAGES[@]}" "${PYTHON_PACKAGES[@]}")

  # Default values for command execution
  POST_COMMAND=""
  COMMAND=""
  OS=$(uname -s | tr '[:upper:]' '[:lower:]') # Default OS assumption

  # Determine if sudo is needed
  SUDO=""
  if [[ "$EUID" -ne 0 ]]; then
    SUDO=sudo
  fi

  # Check if running on Proxmox
  if command -v systemctl >/dev/null 2>&1; then
    if systemctl status pve-cluster 2>&1 | grep -q "running"; then
      OS="proxmox"
      HEADER_PACKAGES=(pve-headers proxmox-default-headers)
    fi
  fi

  # Detect OS and set package manager command
  if [[ -f /etc/os-release ]]; then
    source /etc/os-release
    case $ID in
      debian|ubuntu|mint)
        PACKAGES+=(tldr)
        # Use --no-install-recommends and disable suggests to avoid extra packages
        COMMAND="apt-get install -y --no-install-recommends -o APT::Install-Suggests=false"
        $SUDO apt-get update
        ;;
      alpine)
        PACKAGES=("${BASE_PACKAGES[@]}" apk-tools-zsh-completion linux-headers shadow py3-pip py3-setuptools coreutils zsh-vcs)
        COMMAND="apk add --update"
        POST_COMMAND="$SUDO tee /etc/pam.d/chsh <<< 'auth        sufficient  pam_rootok.so'"
        ;;
      fedora|rhel|centos)
        COMMAND="yum install -y"
        ;;
      *)
        echo "âŒ Unsupported Linux distribution, exiting."
        exit 1
        ;;
    esac
  elif [[ "$OS" == "proxmox" ]]; then
    # Proxmox should use sudo for update and avoid installing recommended/suggested packages
    COMMAND="apt-get install -y --no-install-recommends -o APT::Install-Suggests=false"
    $SUDO apt-get update
  else
    echo "âŒ Unsupported OS, exiting."
    exit 1
  fi

  # Install packages one by one with error handling
  echo "ðŸ“¦ Installing system packages..."
  for package in "${PACKAGES[@]}"; do
    # Check if already installed (dpkg for Debian/Ubuntu, rpm for Fedora)
    if command -v dpkg &>/dev/null && dpkg -l "$package" 2>/dev/null | grep -q "^ii"; then
      echo "  $package: already installed"
      continue
    elif command -v rpm &>/dev/null && rpm -q "$package" &>/dev/null; then
      echo "  $package: already installed"
      continue
    fi
    echo "ðŸ“¦ Installing: $package"
    # shellcheck disable=SC2086  # Word splitting on COMMAND is intentional
    if ! $SUDO $COMMAND "$package"; then
      echo "âŒ Failed to install: $package" >&2
    fi
  done

  # Execute post-install command if needed
  if [[ -n "$POST_COMMAND" ]]; then
    eval "$POST_COMMAND"
  fi

  # Change user shell to zsh
  echo "ðŸ”„ Setting $(whoami) shell to $(which zsh)"
  $SUDO chsh -s "$(which zsh)" "$(whoami)"
}

# macOS-specific setup
setup_macos() {
    echo "macOS detected"
    echo ""

    # Check for Homebrew
    if ! command -v brew &>/dev/null; then
        echo "Homebrew not found. Install it first:"
        # shellcheck disable=SC2016
        echo '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
        echo ""
        exit 1
    fi

    # macOS packages (zsh is already default shell since Catalina)
    local packages=(
        coreutils    # GNU coreutils (gls, gdate, etc.)
        fzf          # Fuzzy finder
        ripgrep      # Fast grep (rg)
        fd           # Fast find
        bat          # Better cat
        eza          # Modern ls
        jq           # JSON processor
        zoxide       # Smart cd
        git-delta    # Better git diff
    )

    echo "Installing packages via Homebrew..."
    for pkg in "${packages[@]}"; do
        if brew list "$pkg" &>/dev/null; then
            echo "  $pkg: already installed"
        else
            echo "  Installing: $pkg"
            brew install "$pkg"
        fi
    done

    # Check if zsh is the default shell (it should be on macOS 10.15+)
    local current_shell
    current_shell=$(dscl . -read ~/ UserShell | awk '{print $2}')
    if [[ "$current_shell" != *"zsh"* ]]; then
        echo "Setting zsh as default shell..."
        chsh -s "$(which zsh)"
    else
        echo "zsh: already default shell"
    fi

    # Install zsh plugins
    source ~/.dotfiles/scripts/zsh-plugins

    echo ""
    echo "macOS setup complete!"
    echo "Restart your terminal or run: source ~/.zshrc"
}

# Platform detection and routing
if is_windows; then
    setup_windows
    exit 0
fi

if is_macos; then
    setup_macos
    exit 0
fi

# Check if running on NixOS and exit if true
if [[ -f /etc/NIXOS ]]; then
    echo "NixOS found, nothing to be done!"
    exit 0
fi

# Run package installation function (Linux only)
install_packages

# Import SSH keys from GitHub if ssh-import-id is available
if command -v ssh-import-id >/dev/null 2>&1; then
    GITHUB_USER="${GITHUB_USER:-ilude}"
    if ! grep -q "$GITHUB_USER" ~/.ssh/authorized_keys 2>/dev/null; then
        echo "Importing .ssh/authorized_keys from github for user $GITHUB_USER..."
        ssh-import-id "gh:$GITHUB_USER"
    else
        echo "SSH keys for $GITHUB_USER already present, skipping import."
    fi
else
    echo "Warning: ssh-import-id not found, skipping SSH key import." >&2
fi

source ~/.dotfiles/scripts/zsh-plugins

echo "Setup completed successfully!"
