#!/usr/bin/env bash
#
# WSL Dotfiles Installer
# Installs dotfiles from Windows dotfiles repo into WSL environment
#
# Usage:
#   From Windows (PowerShell/cmd): wsl --cd ~ ~/.dotfiles/install-wsl
#   From WSL directly: /mnt/c/Users/<user>/.dotfiles/install-wsl
#
# Options:
#   --packages    Also install system packages (apt packages, zsh setup)
#   --help        Show this help message

set -e

# Configuration
CONFIG="install.wsl.yaml"
DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Parse arguments
INSTALL_PACKAGES=false
for arg in "$@"; do
    case $arg in
        --packages)
            INSTALL_PACKAGES=true
            shift
            ;;
        --help|-h)
            echo "WSL Dotfiles Installer"
            echo ""
            echo "Usage: install-wsl [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --packages    Install system packages (apt, zsh, etc.)"
            echo "  --help        Show this help message"
            exit 0
            ;;
    esac
done

# Detect the dotfiles directory
# Priority: 1) Current directory, 2) Script directory, 3) /mnt/c/Users/*/.dotfiles
find_dotfiles_dir() {
    # Check current directory first (for temp copy approach)
    if [[ -f "./install.wsl.yaml" ]]; then
        pwd
        return 0
    fi

    # Check script directory
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [[ -f "$script_dir/install.wsl.yaml" ]]; then
        echo "$script_dir"
        return 0
    fi

    # Try to find in /mnt/c/Users (may fail if mount has issues)
    for dir in /mnt/c/Users/*/; do
        local user=$(basename "$dir" 2>/dev/null)
        if [[ -n "$user" && "$user" != "Public" && "$user" != "Default" && "$user" != "Default User" && "$user" != "All Users" ]]; then
            if [[ -d "${dir}.dotfiles" && -f "${dir}.dotfiles/install.wsl.yaml" ]]; then
                echo "${dir}.dotfiles"
                return 0
            fi
        fi
    done 2>/dev/null

    return 1
}

BASEDIR=$(find_dotfiles_dir)

if [[ -z "$BASEDIR" ]]; then
    echo -e "${RED}Error: Could not find dotfiles directory${NC}"
    echo "Expected location: /mnt/c/Users/<username>/.dotfiles"
    exit 1
fi

echo -e "${CYAN}=== WSL Dotfiles Installer ===${NC}"
echo -e "Dotfiles directory: ${GREEN}$BASEDIR${NC}"
echo ""

# Check if running inside WSL
if [[ -z "$WSL_DISTRO_NAME" && ! -f /proc/sys/fs/binfmt_misc/WSLInterop ]]; then
    echo -e "${YELLOW}Warning: This script is designed to run inside WSL${NC}"
    echo "Current environment may not be WSL."
    echo ""
fi

# Ensure ~/.claude directory exists
mkdir -p ~/.claude

# Change to dotfiles directory
cd "$BASEDIR"

# Check if we have dotbot or need to do manual linking
USE_DOTBOT=false
if [[ -f "${DOTBOT_DIR}/${DOTBOT_BIN}" ]]; then
    USE_DOTBOT=true
elif [[ -d ".git" ]]; then
    echo -e "${YELLOW}Initializing dotbot submodule...${NC}"
    git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive 2>/dev/null || true
    git submodule update --init --recursive "${DOTBOT_DIR}" 2>/dev/null && USE_DOTBOT=true
fi

if [[ "$USE_DOTBOT" == "true" ]]; then
    # Find Python
    PYTHON=""
    if command -v python3 &>/dev/null; then
        PYTHON="python3"
    elif command -v python &>/dev/null; then
        PYTHON="python"
    else
        echo -e "${RED}Error: Python not found. Please install python3.${NC}"
        exit 1
    fi

    echo -e "${CYAN}Running dotbot...${NC}"
    "$PYTHON" "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Dotbot completed successfully!${NC}"
    else
        echo -e "${YELLOW}Dotbot completed with warnings.${NC}"
    fi
else
    # Manual copy fallback (when dotbot isn't available, e.g., temp directory install)
    echo -e "${CYAN}Dotbot not available, performing manual setup...${NC}"

    # Copy shell configs (not link, since source may be temporary)
    for file in .zshrc .zprofile .profile .bashrc .bash_profile .gitconfig .dircolors; do
        if [[ -f "${BASEDIR}/${file}" ]]; then
            # Remove existing symlink if present
            [[ -L ~/${file} ]] && rm -f ~/${file}
            cp -f "${BASEDIR}/${file}" ~/${file}
            echo "  Copied: ~/${file}"
        fi
    done

    # Copy Oh My Posh config
    if [[ -f "${BASEDIR}/config/ohmyposh/prompt.json" ]]; then
        mkdir -p ~/.config/ohmyposh
        [[ -L ~/.config/ohmyposh/prompt.json ]] && rm -f ~/.config/ohmyposh/prompt.json
        cp -f "${BASEDIR}/config/ohmyposh/prompt.json" ~/.config/ohmyposh/prompt.json
        echo "  Copied: ~/.config/ohmyposh/prompt.json"
    fi

    # Copy Claude status script
    if [[ -f "${BASEDIR}/.claude/claude-status" ]]; then
        mkdir -p ~/.claude
        [[ -L ~/.claude/claude-status ]] && rm -f ~/.claude/claude-status
        cp -f "${BASEDIR}/.claude/claude-status" ~/.claude/claude-status
        chmod +x ~/.claude/claude-status
        echo "  Copied: ~/.claude/claude-status"
    fi

    echo -e "${GREEN}Manual setup completed!${NC}"
fi

# Install packages if requested
if [[ "$INSTALL_PACKAGES" == "true" ]]; then
    echo ""
    echo -e "${CYAN}Installing system packages...${NC}"

    # Prefer wsl-packages (modern, idempotent) over zsh-setup
    if [[ -f "${BASEDIR}/wsl-packages" ]]; then
        bash "${BASEDIR}/wsl-packages"
    elif [[ -f "${BASEDIR}/zsh-setup" ]]; then
        # Fallback to zsh-setup in Linux mode
        unset WINDIR
        export OSTYPE="linux-gnu"
        bash "${BASEDIR}/zsh-setup"
    else
        echo -e "${YELLOW}No package installer found, skipping${NC}"
    fi
fi

# Install zsh plugins (doesn't require packages)
echo ""
echo -e "${CYAN}Setting up zsh plugins...${NC}"
if [[ -f "${BASEDIR}/zsh-plugins" ]]; then
    # Copy to ~/.dotfiles/ so .zshrc can source it
    mkdir -p ~/.dotfiles
    cp -f "${BASEDIR}/zsh-plugins" ~/.dotfiles/zsh-plugins
    chmod +x ~/.dotfiles/zsh-plugins
    source "${BASEDIR}/zsh-plugins"
    echo -e "${GREEN}Zsh plugins installed!${NC}"
fi

echo ""
echo -e "${GREEN}=== WSL Setup Complete ===${NC}"
echo ""
echo "If zsh isn't your default shell, run: chsh -s \$(which zsh)"
echo ""
